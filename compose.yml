services:
  # Nginx reverse proxy - single entry point on port 3000
  nginx:
    image: nginx:alpine
    ports:
      - "${PORT:-3000}:3000"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      convex-backend:
        condition: service_healthy
      nextjs:
        condition: service_started
    networks:
      - app-net

  # Next.js development server with hot reloading
  # Runs init.sh first to deploy Convex functions and seed data
  nextjs:
    image: node:22-alpine
    working_dir: /app
    command: sh -c "corepack enable && pnpm install && sh scripts/init.sh && pnpm dev --port 3001"
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.next
    env_file: ".env.local"
    environment:
      - CONVEX_SELF_HOSTED_URL=http://convex-backend:3210
      - WATCHPACK_POLLING=true
    depends_on:
      convex-backend:
        condition: service_healthy
    networks:
      - app-net

  # Convex backend
  convex-backend:
    image: ghcr.io/get-convex/convex-backend:latest
    stop_grace_period: 10s
    stop_signal: SIGINT
    ports:
      - "3210:3210"
    volumes:
      - convex-data:/convex/data
    env_file: ".env.local"
    environment:
      - CONVEX_CLOUD_ORIGIN=${CONVEX_CLOUD_ORIGIN:-http://127.0.0.1:3210}
      - CONVEX_SITE_ORIGIN=${CONVEX_SITE_ORIGIN:-http://127.0.0.1:3211}
      # Storage URLs and auth domain - must be the public nginx URL
      # - CONVEX_SITE_URL=http://localhost:${PORT:-3000}/convex
    healthcheck:
      test: curl -f http://localhost:3210/version
      interval: 5s
      start_period: 10s
    networks:
      - app-net

  # Convex dashboard (optional, accessible on port 6791)
  convex-dashboard:
    image: ghcr.io/get-convex/convex-dashboard:latest
    stop_grace_period: 10s
    stop_signal: SIGINT
    ports:
      - "${DASHBOARD_PORT:-6791}:6791"
    environment:
      - NEXT_PUBLIC_DEPLOYMENT_URL=http://127.0.0.1:3210
    depends_on:
      convex-backend:
        condition: service_healthy
    networks:
      - app-net

volumes:
  convex-data:

networks:
  app-net:
