services:
  # Next.js development server with hot reloading
  # Runs init.sh first to deploy Convex functions and seed data
  nextjs:
    image: node:22-alpine
    working_dir: /app
    command: sh -c "corepack enable && pnpm install && sh scripts/init.sh && pnpm dev --port 3000"
    ports:
      - 3000:3000
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.next
    env_file: ".env.local"
    environment:
      - CONVEX_SELF_HOSTED_URL=http://convex-backend:3210
      - WATCHPACK_POLLING=true
    depends_on:
      convex-backend:
        condition: service_healthy
    networks:
      - app-net

  convex-backend:
    image: ghcr.io/get-convex/convex-backend:latest
    stop_grace_period: 10s
    stop_signal: SIGINT
    ports:
      - 3210:3210
      - 3211:3211  # HTTP actions port - exposed for OIDC discovery
    volumes:
      - convex-data:/convex/data
    env_file: ".env.local"
    environment:
      # CONVEX_SITE_ORIGIN makes process.env.CONVEX_SITE_URL available in Convex functions
      - CONVEX_SITE_ORIGIN=http://localhost:3211
    # Allow container to reach host's localhost for OIDC discovery
    extra_hosts:
      - "localhost:host-gateway"
    healthcheck:
      test: curl -f http://localhost:3210/version
      interval: 5s
      start_period: 10s
    networks:
      - app-net

  # Convex dashboard (optional, accessible on port 6791)
  convex-dashboard:
    image: ghcr.io/get-convex/convex-dashboard:latest
    stop_grace_period: 10s
    stop_signal: SIGINT
    ports:
      - 6791:6791
    environment:
      - NEXT_PUBLIC_DEPLOYMENT_URL=http://convex-backend:3210
    depends_on:
      convex-backend:
        condition: service_healthy
    networks:
      - app-net

volumes:
  convex-data:

networks:
  app-net:
