services:
  # Next.js production app (standalone - requires separate Convex backend)
  openfit:
    image: ghcr.io/soodoh/openfit-standalone:latest
    container_name: openfit
    restart: unless-stopped
    env_file: .env
    environment:
      # Internal URL for server-side communication
      - CONVEX_SELF_HOSTED_URL=http://convex-backend:3210
      - INSTANCE_NAME=convex-self-hosted
      # Public URL uses nginx proxy
      - NEXT_PUBLIC_CONVEX_URL=http://localhost:${APP_PORT:-3000}/convex
    networks:
      - openfit-net

  # Convex backend
  convex-backend:
    image: ghcr.io/get-convex/convex-backend:latest
    container_name: convex-backend
    restart: unless-stopped
    stop_grace_period: 10s
    stop_signal: SIGINT
    env_file: .env
    environment:
      - CONVEX_CLOUD_ORIGIN=http://127.0.0.1:3210
      - CONVEX_SITE_ORIGIN=http://127.0.0.1:3211
      # Storage URLs and auth domain - must be the public nginx URL
      - CONVEX_SITE_URL=http://localhost:${APP_PORT:-3000}/convex
      - CONVEX_SELF_HOSTED_URL=http://127.0.0.1:3210
      - DOCUMENT_RETENTION_DELAY=172800
      - INSTANCE_NAME=convex-self-hosted
    volumes:
      - convex-data:/convex/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sf http://localhost:3210/version || wget -q --spider http://localhost:3210/version || exit 1",
        ]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - openfit-net

volumes:
  convex-data:

networks:
  openfit-net:
