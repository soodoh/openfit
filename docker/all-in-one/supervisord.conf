[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# Convex backend - starts first (priority 10)
[program:convex]
command=/convex/bin/convex-local-backend /convex/data/convex.sqlite3 --local-storage /convex/data/storage --instance-name %(ENV_INSTANCE_NAME)s --instance-secret %(ENV_INSTANCE_SECRET)s --convex-origin %(ENV_CONVEX_CLOUD_ORIGIN)s --convex-site %(ENV_CONVEX_SITE_ORIGIN)s
directory=/convex
user=convex
priority=10
autostart=true
autorestart=true
startsecs=5
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/convex.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3

# Next.js server - starts after Convex (priority 20)
[program:nextjs]
command=node server.js
directory=/app
user=root
priority=20
autostart=true
autorestart=true
startsecs=5
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/nextjs.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
environment=NODE_ENV="production",
            PORT="3001",
            HOSTNAME="0.0.0.0",
            CONVEX_SELF_HOSTED_URL="%(ENV_CONVEX_SELF_HOSTED_URL)s"

# nginx - starts last (priority 30)
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
priority=30
autostart=true
autorestart=true
startsecs=2
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/nginx.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
